name: Comment Comic Image on New Issue
on:
  issues:
    types:
      - opened

jobs:
  comment_comic_image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Extract Comic Image URL
        id: extract_comic_image
        run: |
          const puppeteer = require('puppeteer');

          async function getComicImage() {
            const browser = await puppeteer.launch();
            const page = await browser.newPage();
            await page.goto('https://explosm.net/comics/kris-watch');
            const comicImage = await page.$eval('#main-comic', (element) => element.getAttribute('src'));
            await browser.close();
            return comicImage;
          }

          getComicImage().then((comicImage) => {
            console.log(`::set-output name=comic_url::${comicImage}`);
          });

      - name: Comment Comic Image
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueComment = `![Cyanide & Happiness Comic Image](${{ steps.extract_comic_image.outputs.comic_url }})`;
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: issueComment
            });

